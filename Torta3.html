<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Torta - Prender vela</title>
  <style>
    :root{
      --bg:#111;
      --card:#fff;
      --accent:#ff6b00;
      --text:#111;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#f8f7f2, #fff);display:flex;align-items:center;justify-content:center}

    .app{width:100%;max-width:540px;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}

    .scene{position:relative;width:100%;display:flex;align-items:center;justify-content:center}
    .cake-wrap{width:100%;max-width:420px;position:relative}
    .cake-wrap .cake{width:100%;height:auto;display:block;border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.12)}

    .flame{position:absolute;left:50%;top:38%;transform:translate(-50%,-100%);pointer-events:none;display:none;width:6.5%;min-width:28px;max-width:90px}

    .flame .f{position:relative;width:100%;padding-top:170%;border-radius:50% 50% 35% 35%/60% 60% 40% 40%;transform-origin:center bottom}
    .flame .f::before{content:'';position:absolute;left:50%;top:18%;transform:translateX(-50%);width:52%;height:72%;border-radius:50% 50% 35% 35%/60% 60% 40% 40%;background: radial-gradient(ellipse at 50% 30%, rgba(255, 255, 180, 1) 0%, rgba(255, 200, 80, 1) 40%, rgba(255, 120, 30, 1) 75%, rgba(255, 60, 0, 1) 100%);box-shadow:0 0 15px 6px rgba(255,180,80,0.9)}
    .flame .f::after{content:'';position:absolute;left:50%;top:34%;transform:translateX(-50%);width:35%;height:45%;border-radius:50%;background:radial-gradient(circle at 40% 30%, rgba(255,255,255,0.95), rgba(255,230,100,0.8));opacity:1;box-shadow:0 0 10px 4px rgba(255,200,100,0.9)}

    @keyframes flickerS{0%{transform:translateY(0) scale(1)}25%{transform:translateY(-2%) scale(.98)}50%{transform:translateY(0) scale(1.02)}75%{transform:translateY(-1%) scale(.99)}100%{transform:translateY(0) scale(1)}}
    .flame .f{animation: flickerS 160ms infinite alternate}

    .controls{width:100%;display:flex;justify-content:center;margin-top:14px}
    button.big{appearance:none;border:0;background:var(--accent);color:white;padding:14px 20px;border-radius:12px;font-size:5.6vw;min-font-size:18px;font-weight:700;max-width:420px;width:90%;max-font-size:22px;box-shadow:0 8px 18px rgba(0,0,0,.12)}
    button.big{font-size:clamp(18px,5.6vw,26px);padding:clamp(12px,3.2vw,18px)}

    .overlay{position:fixed;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .message{pointer-events:auto;background:rgba(0,0,0,.6);color:white;padding:20px 28px;border-radius:14px;font-size:clamp(20px,5.6vw,36px);text-align:center;backdrop-filter:blur(6px);}

    #meter{position:fixed;left:8px;bottom:8px;background:rgba(255,255,255,.92);padding:6px 8px;border-radius:8px;font-size:12px;display:none}

    @media (orientation:landscape){.app{max-width:760px}}
  </style>
</head>
<body>
  <div class="app">
    <div class="scene">
      <div class="cake-wrap" id="cakeWrap">
        <img src="torta.jpg" alt="Torta" class="cake" id="cakeImg" />
        <div class="flame" id="flame" aria-hidden="true">
          <div class="f"></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="btnToggle" class="big">Prender vela</button>
    </div>

    <div class="overlay" id="overlay" style="display:none">
      <div class="message" id="overlayMsg">ped√≠ un deseo y sopla la velita</div>
    </div>

    <audio id="song" src="cancion.mp3" preload="auto" playsinline></audio>
    <audio id="applause" src="aplausos.mp3" preload="auto" playsinline></audio>

    <div id="meter">--</div>
  </div>

<script>
const btn = document.getElementById('btnToggle');
const flame = document.getElementById('flame');
const song = document.getElementById('song');
const applause = document.getElementById('applause');
const overlay = document.getElementById('overlay');
const meter = document.getElementById('meter');

let audioCtx=null, analyser=null, micStream=null, dataArray=null, rafId=null;
let isLit = false;
let waitingForBlow = false;
let songPlaying = false;
let blownDuringSong = false;

const BLOW_RMS_THRESHOLD = 0.06;
const BLOW_MIN_MS = 120;

let blowTickStart = null;

async function initMic(){
  if(audioCtx) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    micStream = stream;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    source.connect(analyser);
    dataArray = new Float32Array(analyser.fftSize);
  }catch(e){console.warn('No mic', e);}
}

function startMonitoring(){
  if(!analyser) return;
  cancelAnimationFrame(rafId);
  function loop(){
    analyser.getFloatTimeDomainData(dataArray);
    let sum=0;for(let i=0;i<dataArray.length;i++){sum+=dataArray[i]*dataArray[i];}
    const rms=Math.sqrt(sum/dataArray.length);
    meter.textContent='RMS: '+rms.toFixed(4);
    const now=performance.now();
    if(rms>BLOW_RMS_THRESHOLD){
      if(!blowTickStart) blowTickStart=now;
      else if(now-blowTickStart>BLOW_MIN_MS){handleBlowDetected();blowTickStart=null;}
    }else blowTickStart=null;
    rafId=requestAnimationFrame(loop);
  }
  rafId=requestAnimationFrame(loop);
}
function stopMonitoring(){cancelAnimationFrame(rafId);}

async function handleBlowDetected(){
  if(!isLit) return;
  if(songPlaying){
    blownDuringSong=true;
    song.pause();song.currentTime=0;songPlaying=false;waitingForBlow=false;hideOverlay();
    extinguishAndApplaud();
  }else if(waitingForBlow){
    waitingForBlow=false;hideOverlay();extinguishAndApplaud();
  }
}

function extinguishAndApplaud(){
  flame.style.display='none';isLit=false;
  stopMonitoring();
  playAudio(applause).then(()=>{resetToStandby();});
}

function showOverlay(){overlay.style.display='flex';}
function hideOverlay(){overlay.style.display='none';}

function resetToStandby(){
  try{song.pause();song.currentTime=0;}catch(e){}
  try{applause.pause();applause.currentTime=0;}catch(e){}
  waitingForBlow=false;songPlaying=false;blownDuringSong=false;isLit=false;
  flame.style.display='none';hideOverlay();
}

async function playAudio(el){
  return new Promise((res)=>{
    function onend(){el.removeEventListener('ended',onend);el.removeEventListener('error',onerr);res();}
    function onerr(){el.removeEventListener('ended',onend);el.removeEventListener('error',onerr);res();}
    el.addEventListener('ended',onend);
    el.addEventListener('error',onerr);
    el.currentTime=0;
    const p=el.play();if(p&&p.catch){p.catch(()=>res());}
  });
}

btn.addEventListener('click', async ()=>{
  if(isLit) return;

  // üîπ stop applause if playing before restarting
  try{applause.pause();applause.currentTime=0;}catch(e){}

  await initMic();startMonitoring();
  flame.style.display='block';isLit=true;blownDuringSong=false;
  songPlaying=true;hideOverlay();
  const playPromise=song.play();if(playPromise&&playPromise.catch){playPromise.catch(()=>{});}

  function onSongEnd(){
    songPlaying=false;song.removeEventListener('ended',onSongEnd);
    if(!blownDuringSong){waitingForBlow=true;showOverlay();}
  }
  song.addEventListener('ended',onSongEnd);
});

window.addEventListener('pagehide',()=>{try{if(micStream){micStream.getTracks().forEach(t=>t.stop());}}catch(e){}if(audioCtx){try{audioCtx.close();}catch(e){}}});
btn.addEventListener('keydown',(e)=>{if(e.key==='Enter')btn.click();});

function updateFlamePosition(){}
window.addEventListener('resize',updateFlamePosition);
updateFlamePosition();
</script>
</body>
</html>
